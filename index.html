<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Analyzer Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .dashboard, .calibration {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 300px;
        }
        .dashboard h2, .calibration h2 {
            margin-top: 0;
        }
        .parameter {
            margin: 10px 0;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .parameter label {
            font-weight: bold;
            display: block;
        }
        .parameter span {
            font-size: 1.2em;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        button[type="button"] {
            background-color: #6c757d;
        }
        button:hover {
            opacity: 0.9;
        }
        #calibration-status {
            margin: 10px 0;
            font-weight: bold;
        }
        #last-updated {
            font-style: italic;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <h2>Water Analyzer Dashboard</h2>
            <div class="parameter">
                <label>COD</label>
                <span id="cod-value">00.00 mg/l</span>
            </div>
            <div class="parameter">
                <label>BOD</label>
                <span id="bod-value">00.00 mg/l</span>
            </div>
            <div class="parameter">
                <label>TSS</label>
                <span id="tss-value">00.00 mg/l</span>
            </div>
            <div class="parameter">
                <label>pH</label>
                <span id="ph-value">00.00</span>
            </div>
            <div class="parameter">
                <label>Flow</label>
                <span id="flow-value">00.00 m³/h</span>
            </div>
            <div class="parameter">
                <label>Daily Flow</label>
                <span id="daily-flow-value">00.00 m³/d</span>
            </div>
            <div id="last-updated">Last updated: --</div>
            <button id="reset-button">Reset</button>
        </div>

        <div class="calibration">
            <h2>Calibration Settings</h2>
            <div id="calibration-status"></div>
            <form id="calibration-form">
                <div class="form-group">
                    <label for="cod-input">COD (mg/l)</label>
                    <input type="number" id="cod-input" step="0.01" placeholder="Last fetched: 00.00 mg/l">
                </div>
                <div class="form-group">
                    <label for="bod-input">BOD (mg/l)</label>
                    <input type="number" id="bod-input" step="0.01" placeholder="Last fetched: 00.00 mg/l">
                </div>
                <div class="form-group">
                    <label for="tss-input">TSS (mg/l)</label>
                    <input type="number" id="tss-input" step="0.01" placeholder="Last fetched: 00.00 mg/l">
                </div>
                <div class="form-group">
                    <label for="ph-input">pH</label>
                    <input type="number" id="ph-input" step="0.01" placeholder="Last fetched: 00.00">
                </div>
                <div class="form-group">
                    <label for="flow-input">Flow (m³/h)</label>
                    <input type="number" id="flow-input" step="0.01" placeholder="Last fetched: 00.00 m³/h">
                </div>
                <div class="form-group">
                    <label for="daily-flow-input">Daily Flow (m³/d)</label>
                    <input type="number" id="daily-flow-input" step="0.01" placeholder="Last fetched: 00.00 m³/d">
                </div>
                <button type="button" id="clear-button">Clear</button>
                <button type="submit">Submit</button>
            </form>
        </div>
    </div>

    <script>
        // Fetch data from /api/data and update dashboard
        function fetchData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'unavailable') {
                        document.getElementById('last-updated').textContent = 'Server unavailable';
                        return;
                    }
                    document.getElementById('cod-value').textContent = (data.cod || '00.00') + ' mg/l';
                    document.getElementById('bod-value').textContent = (data.bod || '00.00') + ' mg/l';
                    document.getElementById('tss-value').textContent = (data.tss || '00.00') + ' mg/l';
                    document.getElementById('ph-value').textContent = (data.ph_value || '00.00');
                    document.getElementById('flow-value').textContent = (data.flow_rate || '00.00') + ' m³/h';
                    document.getElementById('daily-flow-value').textContent = (data.flow_total || '00.00') + ' m³/d';
                    document.getElementById('last-updated').textContent = 'Last updated: ' + new Date().toLocaleString();

                    document.getElementById('cod-input').placeholder = 'Last fetched: ' + (data.cod || '00.00') + ' mg/l';
                    document.getElementById('bod-input').placeholder = 'Last fetched: ' + (data.bod || '00.00') + ' mg/l';
                    document.getElementById('tss-input').placeholder = 'Last fetched: ' + (data.tss || '00.00') + ' mg/l';
                    document.getElementById('ph-input').placeholder = 'Last fetched: ' + (data.ph_value || '00.00');
                    document.getElementById('flow-input').placeholder = 'Last fetched: ' + (data.flow_rate || '00.00') + ' m³/h';
                    document.getElementById('daily-flow-input').placeholder = 'Last fetched: ' + (data.flow_total || '00.00') + ' m³/d';
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('last-updated').textContent = 'Error fetching data';
                });
        }

        // Check calibration status
        function checkCalibrationStatus() {
            fetch('/api/calibration_status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.createElement('div');
                    statusElement.textContent = data.calibration_active ? 'Calibration Mode Active' : 'Normal Mode';
                    statusElement.style.color = data.calibration_active ? 'red' : 'green';
                    document.getElementById('calibration-status').innerHTML = '';
                    document.getElementById('calibration-status').appendChild(statusElement);
                })
                .catch(error => {
                    console.error('Error checking calibration status:', error);
                    document.getElementById('calibration-status').textContent = 'Error checking calibration status';
                });
        }

        // Submit calibration data
        function submitCalibration() {
            const calibrationData = {
                cod: parseFloat(document.getElementById('cod-input').value) || null,
                bod: parseFloat(document.getElementById('bod-input').value) || null,
                tss: parseFloat(document.getElementById('tss-input').value) || null,
                ph: parseFloat(document.getElementById('ph-input').value) || null,
                flow: parseFloat(document.getElementById('flow-input').value) || null,
                daily_flow: parseFloat(document.getElementById('daily-flow-input').value) || null
            };

            fetch('/api/calibrate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(calibrationData)
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.status === 'success') {
                        document.getElementById('calibration-form').reset();
                        checkCalibrationStatus();
                    }
                })
                .catch(error => {
                    console.error('Error submitting calibration:', error);
                    alert('Error submitting calibration');
                });
        }

        // Reset calibration
        function resetCalibration() {
            fetch('/api/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.status === 'success') {
                        document.getElementById('calibration-form').reset();
                        checkCalibrationStatus();
                    }
                })
                .catch(error => {
                    console.error('Error resetting calibration:', error);
                    alert('Error resetting calibration');
                });
        }

        // Clear form
        function clearForm() {
            document.getElementById('calibration-form').reset();
        }

        // Attach event listeners
        document.getElementById('calibration-form').addEventListener('submit', (e) => {
            e.preventDefault();
            submitCalibration();
        });
        document.getElementById('clear-button').addEventListener('click', clearForm);
        document.getElementById('reset-button').addEventListener('click', resetCalibration);

        // Periodically fetch data and check calibration status
        setInterval(fetchData, 5000);
        setInterval(checkCalibrationStatus, 5000);
        fetchData();
        checkCalibrationStatus();
    </script>
</body>
</html>