{% extends 'monitoring_app/base.html' %}

{% block content %}
<div class="sliding-header">
    <h1>Live Status for {{ user.username }}</h1>
    <p>Real-time water quality monitoring data</p>
    <small id="last-updated">Last updated: Never</small>
</div>

<div id="connection-error" class="alert alert-danger mb-3" style="display: none;">
    Connection error. Unable to fetch latest data. Please check your network connection.
</div>

{% if user.show_ph or user.show_cod or user.show_bod or user.show_tss %}
<div class="row text-center mb-4">
    {% if user.show_ph and user.show_cod and user.show_bod and user.show_tss %}
        <div class="col-md-6 mb-3">
            {% if user.show_ph %}
            <div class="data-card"><h3>pH</h3><p id="phValue">-</p></div>
            {% endif %}
        </div>
        <div class="col-md-6 mb-3">
            {% if user.show_cod %}
            <div class="data-card"><h3>COD</h3><p id="codValue">-</p></div>
            {% endif %}
        </div>
        <div class="col-md-6 mb-3">
            {% if user.show_bod %}
            <div class="data-card"><h3>BOD</h3><p id="bodValue">-</p></div>
            {% endif %}
        </div>
        <div class="col-md-6 mb-3">
            {% if user.show_tss %}
            <div class="data-card"><h3>TSS</h3><p id="tssValue">-</p></div>
            {% endif %}
        </div>
    {% else %}
        {% if user.show_ph %}
        <div class="col-md-{% if user.show_ph and user.show_cod and user.show_bod %}4{% elif user.show_ph and user.show_cod %}6{% else %}12{% endif %} mb-3">
            <div class="data-card"><h3>pH</h3><p id="phValue">-</p></div>
        </div>
        {% endif %}
        {% if user.show_cod %}
        <div class="col-md-{% if user.show_ph and user.show_cod and user.show_bod %}4{% elif user.show_ph and user.show_cod %}6{% else %}12{% endif %} mb-3">
            <div class="data-card"><h3>COD</h3><p id="codValue">-</p></div>
        </div>
        {% endif %}
        {% if user.show_bod %}
        <div class="col-md-{% if user.show_ph and user.show_cod and user.show_bod %}4{% elif user.show_bod and user.show_tss %}6{% else %}12{% endif %} mb-3">
            <div class="data-card"><h3>BOD</h3><p id="bodValue">-</p></div>
        </div>
        {% endif %}
        {% if user.show_tss %}
        <div class="col-md-{% if user.show_bod and user.show_tss %}6{% else %}12{% endif %} mb-3">
            <div class="data-card"><h3>TSS</h3><p id="tssValue">-</p></div>
        </div>
        {% endif %}
    {% endif %}
</div>
{% endif %}

{% if user.show_flow1 %}
<div class="row text-center mb-4">
    <div class="col-md-3 mb-3"><div class="data-card"><h3>Flow 1</h3><p id="flow1Value">-</p></div></div>
</div>
{% endif %}
{% if user.show_flow2 %}
<div class="row text-center mb-4">
    <div class="col-md-3 mb-3"><div class="data-card"><h3>Flow 2</h3><p id="flow2Value">-</p></div></div>
</div>
{% endif %}
{% if user.show_flow3 %}
<div class="row text-center mb-4">
    <div class="col-md-3 mb-3"><div class="data-card"><h3>Flow 3</h3><p id="flow3Value">-</p></div></div>
</div>
{% endif %}

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <span id="view-title">Historical Data (Last 50 Records)</span>
                    <div class="float-end">
                        <button class="btn btn-sm btn-light me-2" id="historical-btn">Historical</button>
                        <button class="btn btn-sm btn-light" id="graphic-btn">Graphic View</button>
                    </div>
                </h5>
            </div>
            <div class="card-body">
                <div id="historical-view" class="table-responsive">
                    <table class="table table-striped table-hover" id="history-table">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                {% if user.show_ph %}<th>pH</th>{% endif %}
                                {% if user.show_flow1 %}<th>Flow 1 (L/min)</th>{% endif %}
                                {% if user.show_flow2 %}<th>Flow 2 (L/min)</th>{% endif %}
                                {% if user.show_flow3 %}<th>Flow 3 (L/min)</th>{% endif %}
                                {% if user.show_cod %}<th>COD (mg/L)</th>{% endif %}
                                {% if user.show_bod %}<th>BOD (mg/L)</th>{% endif %}
                                {% if user.show_tss %}<th>TSS (mg/L)</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="history-body">
                        </tbody>
                    </table>
                </div>
                <div id="graphic-view" style="display: none;">
                    <div id="charts-container" class="row"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="text-center mt-4 mb-4">
    <a href="{% url 'dashboard' %}" class="btn btn-secondary me-2">Back to Dashboard</a>
    <a href="{% url 'download_page' user.id %}" class="btn btn-primary">Download Data</a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const userId = {{ user.id }};
    let lastDataTimestamp = null;
    let chartInstances = {};
    let updateInterval = null;
    let isGraphicView = false;

    function formatValue(value, unit = '', nullText = '-', forceDecimals = false) {
        if (value === null || value === undefined || value === '') {
            return nullText;
        }
        const numValue = typeof value === 'string' ? parseFloat(value) : value;
        if (forceDecimals || unit.includes('L/min') || unit.includes('L') || unit.includes('mg/L')) {
            return `${numValue.toFixed(2)} ${unit}`.trim();
        }
        return `${numValue} ${unit}`.trim();
    }

    function displayConnectionError(show) {
        if (show) {
            $('#connection-error').show();
        } else {
            $('#connection-error').hide();
        }
    }

    function fetchLatestData() {
        $.ajax({
            url: `/api/water-quality/latest/?user_id=${userId}`,
            method: 'GET',
            success: function(wqData) {
                $.ajax({
                    url: `/api/readings/latest/?user_id=${userId}`,
                    method: 'GET',
                    success: function(flowData) {
                        displayConnectionError(false);
                        const timestamp = wqData.timestamp || Object.values(flowData)[0]?.recorded_at;
                        if (!timestamp) {
                            document.getElementById("last-updated").innerText = 'Last updated: No data available';
                            return;
                        }
                        const ts = new Date(timestamp);
                        document.getElementById("last-updated").innerText = `Last updated: ${ts.toLocaleString()}`;
                        if (document.getElementById("phValue")) document.getElementById("phValue").innerText = formatValue(wqData.ph);
                        if (document.getElementById("codValue")) document.getElementById("codValue").innerText = formatValue(wqData.cod, 'mg/L', '-', true);
                        if (document.getElementById("bodValue")) document.getElementById("bodValue").innerText = formatValue(wqData.bod, 'mg/L', '-', true);
                        if (document.getElementById("tssValue")) document.getElementById("tssValue").innerText = formatValue(wqData.tss, 'mg/L', '-', true);
                        if (document.getElementById("flow1Value")) document.getElementById("flow1Value").innerText = formatValue(flowData.flow1?.value, 'L/min', '-', true);
                        if (document.getElementById("flow2Value")) document.getElementById("flow2Value").innerText = formatValue(flowData.flow2?.value, 'L/min', '-', true);
                        if (document.getElementById("flow3Value")) document.getElementById("flow3Value").innerText = formatValue(flowData.flow3?.value, 'L/min', '-', true);
                        lastDataTimestamp = timestamp;
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching flow data:', status, error, xhr.responseText);
                        displayConnectionError(true);
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error('Error fetching water quality data:', status, error, xhr.responseText);
                displayConnectionError(true);
            }
        });
    }

    function fetchHistoricalData() {
        $.ajax({
            url: `/api/water-quality/?user_id=${userId}&limit=50`,
            method: 'GET',
            success: function(wqData) {
                $.ajax({
                    url: `/api/readings/?user_id=${userId}&limit=50`,
                    method: 'GET',
                    success: function(flowData) {
                        displayConnectionError(false);
                        // Update historical table
                        const tbody = $('#history-body');
                        tbody.empty();
                        if (!wqData.length && !flowData.length) {
                            tbody.append('<tr><td colspan="100%" class="text-center">No data available</td></tr>');
                            if (isGraphicView) {
                                $('#charts-container').empty().append('<p class="text-center">No data available</p>');
                            }
                            return;
                        }
                        // Combine data
                        let combinedData = [];
                        wqData.forEach(wq => {
                            combinedData.push({
                                timestamp: new Date(wq.timestamp),
                                ph: wq.ph,
                                cod: wq.cod,
                                bod: wq.bod,
                                tss: wq.tss,
                                flow1: null,
                                flow2: null,
                                flow3: null
                            });
                        });
                        flowData.forEach(flow => {
                            let entry = combinedData.find(e => Math.abs(e.timestamp - new Date(flow.recorded_at)) < 1000);
                            if (!entry) {
                                entry = {
                                    timestamp: new Date(flow.recorded_at),
                                    ph: null,
                                    cod: null,
                                    bod: null,
                                    tss: null,
                                    flow1: null,
                                    flow2: null,
                                    flow3: null
                                };
                                combinedData.push(entry);
                            }
                            entry[flow.parameter] = flow.value;
                        });
                        combinedData.sort((a, b) => b.timestamp - a.timestamp);
                        // Update table if in historical view
                        if (!isGraphicView) {
                            combinedData.slice(0, 50).forEach(item => {
                                const row = $('<tr></tr>');
                                row.append(`<td>${item.timestamp.toLocaleString()}</td>`);
                                {% if user.show_ph %}
                                row.append(`<td>${formatValue(item.ph)}</td>`);
                                {% endif %}
                                {% if user.show_flow1 %}
                                row.append(`<td>${formatValue(item.flow1, 'L/min', '-', true)}</td>`);
                                {% endif %}
                                {% if user.show_flow2 %}
                                row.append(`<td>${formatValue(item.flow2, 'L/min', '-', true)}</td>`);
                                {% endif %}
                                {% if user.show_flow3 %}
                                row.append(`<td>${formatValue(item.flow3, 'L/min', '-', true)}</td>`);
                                {% endif %}
                                {% if user.show_cod %}
                                row.append(`<td>${formatValue(item.cod, 'mg/L', '-', true)}</td>`);
                                {% endif %}
                                {% if user.show_bod %}
                                row.append(`<td>${formatValue(item.bod, 'mg/L', '-', true)}</td>`);
                                {% endif %}
                                {% if user.show_tss %}
                                row.append(`<td>${formatValue(item.tss, 'mg/L', '-', true)}</td>`);
                                {% endif %}
                                tbody.append(row);
                            });
                        }
                        // Update charts if in graphic view
                        if (isGraphicView) {
                            initializeCharts(wqData, flowData);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching flow data:', status, error, xhr.responseText);
                        displayConnectionError(true);
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error('Error fetching water quality data:', status, error, xhr.responseText);
                displayConnectionError(true);
            }
        });
    }

    function initializeCharts(wqData, flowData) {
        const container = $('#charts-container');
        container.empty();
        // Destroy existing charts to prevent memory leaks
        Object.values(chartInstances).forEach(chart => chart.destroy());
        chartInstances = {};
        const parameters = [
            {% if user.show_ph %}{ id: 'ph', label: 'pH', color: '#FF6384' },{% endif %}
            {% if user.show_flow1 %}{ id: 'flow1', label: 'Flow 1 (L/min)', color: '#36A2EB' },{% endif %}
            {% if user.show_flow2 %}{ id: 'flow2', label: 'Flow 2 (L/min)', color: '#FFCE56' },{% endif %}
            {% if user.show_flow3 %}{ id: 'flow3', label: 'Flow 3 (L/min)', color: '#FF9F40' },{% endif %}
            {% if user.show_cod %}{ id: 'cod', label: 'COD (mg/L)', color: '#4BC0C0' },{% endif %}
            {% if user.show_bod %}{ id: 'bod', label: 'BOD (mg/L)', color: '#9966FF' },{% endif %}
            {% if user.show_tss %}{ id: 'tss', label: 'TSS (mg/L)', color: '#FF9F40' }{% endif %}
        ];
        parameters.forEach(param => {
            const canvasId = `chart-${param.id}`;
            container.append(`<div class="col-md-6 mb-4"><canvas id="${canvasId}"></canvas></div>`);
            const ctx = document.getElementById(canvasId).getContext('2d');
            let data = [];
            let labels = [];
            if (['ph', 'cod', 'bod', 'tss'].includes(param.id)) {
                data = wqData.map(item => item[param.id] || 0).reverse();
                labels = wqData.map(item => new Date(item.timestamp).toLocaleString()).reverse();
            } else {
                const flowRecords = flowData.filter(item => item.parameter === param.id);
                data = flowRecords.map(item => item.value || 0).reverse();
                labels = flowRecords.map(item => new Date(item.recorded_at).toLocaleString()).reverse();
            }
            chartInstances[param.id] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: param.label,
                        data: data,
                        borderColor: param.color,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { display: true, title: { display: true, text: 'Time' } },
                        y: { display: true, title: { display: true, text: param.label } }
                    }
                }
            });
        });
    }

    $(document).ready(function() {
        fetchLatestData();
        fetchHistoricalData();
        // Update both live and historical data every 5 seconds
        updateInterval = setInterval(() => {
            fetchLatestData();
            fetchHistoricalData();
        }, 5000);
        $('#historical-btn').click(function() {
            isGraphicView = false;
            $('#historical-view').show();
            $('#graphic-view').hide();
            $('#view-title').text('Historical Data (Last 50 Records)');
            $(this).addClass('btn-light').removeClass('btn-outline-light');
            $('#graphic-btn').addClass('btn-outline-light').removeClass('btn-light');
            fetchHistoricalData(); // Immediate update when switching
        });
        $('#graphic-btn').click(function() {
            isGraphicView = true;
            $('#historical-view').hide();
            $('#graphic-view').show();
            $('#view-title').text('Graphic View');
            $(this).addClass('btn-light').removeClass('btn-outline-light');
            $('#historical-btn').addClass('btn-outline-light').removeClass('btn-light');
            fetchHistoricalData(); // Immediate update when switching
        });
    });

    window.onbeforeunload = function() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    };
</script>
{% endblock %}