
{% extends 'monitoring_app/base.html' %}

{% block content %}
<div class="sliding-header">
    <h1>Download Data for {{ user.username }}</h1>
    <p>Select parameters and date range to download data</p>
</div>

{% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
{% endif %}

<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Download Data</h5>
    </div>
    <div class="card-body">
        <form id="download-form">
            {% csrf_token %}
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" required>
                </div>
                <div class="col-md-6">
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" required>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="time_interval" class="form-label">Time Interval (minutes)</label>
                <input type="number" min="0" step="1" class="form-control" id="time_interval" name="time_interval" value="0">
                <small class="form-text text-muted">Set to 0 to include all data points</small>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Select Parameters</label>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="select-all">
                    <label class="form-check-label" for="select-all">Select All</label>
                </div>
                <div class="row">
                    {% if user.show_ph %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="ph" id="ph">
                            <label class="form-check-label" for="ph">pH</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_cod %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="cod" id="cod">
                            <label class="form-check-label" for="cod">COD</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_bod %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="bod" id="bod">
                            <label class="form-check-label" for="bod">BOD</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_tss %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="tss" id="tss">
                            <label class="form-check-label" for="tss">TSS</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow1 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow1" id="flow1">
                            <label class="form-check-label" for="flow1">Flow 1 (L/min)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow1_total" id="flow1_total">
                            <label class="form-check-label" for="flow1_total">Flow 1 Total (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow1_daily" id="flow1_daily">
                            <label class="form-check-label" for="flow1_daily">Flow 1 Daily (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow1_monthly" id="flow1_monthly">
                            <label class="form-check-label" for="flow1_monthly">Flow 1 Monthly (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow2 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow2" id="flow2">
                            <label class="form-check-label" for="flow2">Flow 2 (L/min)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow2_total" id="flow2_total">
                            <label class="form-check-label" for="flow2_total">Flow 2 Total (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow2_daily" id="flow2_daily">
                            <label class="form-check-label" for="flow2_daily">Flow 2 Daily (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow2_monthly" id="flow2_monthly">
                            <label class="form-check-label" for="flow2_monthly">Flow 2 Monthly (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow3 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow3" id="flow3">
                            <label class="form-check-label" for="flow3">Flow 3 (L/min)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow3_total" id="flow3_total">
                            <label class="form-check-label" for="flow3_total">Flow 3 Total (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow3_daily" id="flow3_daily">
                            <label class="form-check-label" for="flow3_daily">Flow 3 Daily (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow3_monthly" id="flow3_monthly">
                            <label class="form-check-label" for="flow3_monthly">Flow 3 Monthly (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow4 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow4" id="flow4">
                            <label class="form-check-label" for="flow4">Flow 4 (L/min)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow4_total" id="flow4_total">
                            <label class="form-check-label" for="flow4_total">Flow 4 Total (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow4_daily" id="flow4_daily">
                            <label class="form-check-label" for="flow4_daily">Flow 4 Daily (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow4_monthly" id="flow4_monthly">
                            <label class="form-check-label" for="flow4_monthly">Flow 4 Monthly (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow5 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow5" id="flow5">
                            <label class="form-check-label" for="flow5">Flow 5 (L/min)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow5_total" id="flow5_total">
                            <label class="form-check-label" for="flow5_total">Flow 5 Total (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow5_daily" id="flow5_daily">
                            <label class="form-check-label" for="flow5_daily">Flow 5 Daily (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow5_monthly" id="flow5_monthly">
                            <label class="form-check-label" for="flow5_monthly">Flow 5 Monthly (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow6 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow6" id="flow6">
                            <label class="form-check-label" for="flow6">Flow 6 (L/min)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow6_total" id="flow6_total">
                            <label class="form-check-label" for="flow6_total">Flow 6 Total (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow6_daily" id="flow6_daily">
                            <label class="form-check-label" for="flow6_daily">Flow 6 Daily (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow6_monthly" id="flow6_monthly">
                            <label class="form-check-label" for="flow6_monthly">Flow 6 Monthly (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow7 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow7" id="flow7">
                            <label class="form-check-label" for="flow7">Flow 7 (L/min)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow7_total" id="flow7_total">
                            <label class="form-check-label" for="flow7_total">Flow 7 Total (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow7_daily" id="flow7_daily">
                            <label class="form-check-label" for="flow7_daily">Flow 7 Daily (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow7_monthly" id="flow7_monthly">
                            <label class="form-check-label" for="flow7_monthly">Flow 7 Monthly (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow8 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow8" id="flow8">
                            <label class="form-check-label" for="flow8">Flow 8 (L/min)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow8_total" id="flow8_total">
                            <label class="form-check-label" for="flow8_total">Flow 8 Total (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow8_daily" id="flow8_daily">
                            <label class="form-check-label" for="flow8_daily">Flow 8 Daily (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow8_monthly" id="flow8_monthly">
                            <label class="form-check-label" for="flow8_monthly">Flow 8 Monthly (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow9 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow9" id="flow9">
                            <label class="form-check-label" for="flow9">Flow 9 (L/min)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow9_total" id="flow9_total">
                            <label class="form-check-label" for="flow9_total">Flow 9 Total (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow9_daily" id="flow9_daily">
                            <label class="form-check-label" for="flow9_daily">Flow 9 Daily (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow9_monthly" id="flow9_monthly">
                            <label class="form-check-label" for="flow9_monthly">Flow 9 Monthly (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow10 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow10" id="flow10">
                            <label class="form-check-label" for="flow10">Flow 10 (L/min)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow10_total" id="flow10_total">
                            <label class="form-check-label" for="flow10_total">Flow 10 Total (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow10_daily" id="flow10_daily">
                            <label class="form-check-label" for="flow10_daily">Flow 10 Daily (L)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input parameter-checkbox" type="checkbox" name="flow10_monthly" id="flow10_monthly">
                            <label class="form-check-label" for="flow10_monthly">Flow 10 Monthly (L)</label>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- New section for daily totals -->
            <div class="mb-3">
                <label class="form-label">Daily Flow Totals (One entry per day)</label>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="select-all-daily">
                    <label class="form-check-label" for="select-all-daily">Select All Daily Totals</label>
                </div>
                <div class="row">
                    {% if user.show_flow1 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input daily-total-checkbox" type="checkbox" name="daily_flow1" id="daily_flow1">
                            <label class="form-check-label" for="daily_flow1">Flow 1 Daily Total (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow2 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input daily-total-checkbox" type="checkbox" name="daily_flow2" id="daily_flow2">
                            <label class="form-check-label" for="daily_flow2">Flow 2 Daily Total (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow3 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input daily-total-checkbox" type="checkbox" name="daily_flow3" id="daily_flow3">
                            <label class="form-check-label" for="daily_flow3">Flow 3 Daily Total (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow4 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input daily-total-checkbox" type="checkbox" name="daily_flow4" id="daily_flow4">
                            <label class="form-check-label" for="daily_flow4">Flow 4 Daily Total (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow5 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input daily-total-checkbox" type="checkbox" name="daily_flow5" id="daily_flow5">
                            <label class="form-check-label" for="daily_flow5">Flow 5 Daily Total (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow6 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input daily-total-checkbox" type="checkbox" name="daily_flow6" id="daily_flow6">
                            <label class="form-check-label" for="daily_flow6">Flow 6 Daily Total (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow7 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input daily-total-checkbox" type="checkbox" name="daily_flow7" id="daily_flow7">
                            <label class="form-check-label" for="daily_flow7">Flow 7 Daily Total (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow8 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input daily-total-checkbox" type="checkbox" name="daily_flow8" id="daily_flow8">
                            <label class="form-check-label" for="daily_flow8">Flow 8 Daily Total (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow9 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input daily-total-checkbox" type="checkbox" name="daily_flow9" id="daily_flow9">
                            <label class="form-check-label" for="daily_flow9">Flow 9 Daily Total (L)</label>
                        </div>
                    </div>
                    {% endif %}
                    {% if user.show_flow10 %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input daily-total-checkbox" type="checkbox" name="daily_flow10" id="daily_flow10">
                            <label class="form-check-label" for="daily_flow10">Flow 10 Daily Total (L)</label>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">File Format</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="format" id="excel" value="excel" checked>
                    <label class="form-check-label" for="excel">Excel</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="format" id="pdf" value="pdf">
                    <label class="form-check-label" for="pdf">PDF</label>
                </div>
            </div>
            
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary" id="download-btn">Download</button>
                <button type="button" class="btn btn-info" id="preview-btn">Preview</button>
                <a href="{% url 'user_management' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div class="mt-4" id="preview-section" style="display: none;">
    <h3>Preview Data</h3>
    <table class="table table-striped table-bordered" id="preview-table">
        <thead></thead>
        <tbody></tbody>
    </table>
</div>

<div class="text-center mt-4">
    <a href="{% url 'download_user_credentials' user.id %}" class="btn btn-info">Go To Dashboard</a>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Select All checkbox functionality
    $('#select-all').on('change', function() {
        $('.parameter-checkbox').prop('checked', this.checked);
    });

    // Select All Daily Totals checkbox functionality
    $('#select-all-daily').on('change', function() {
        $('.daily-total-checkbox').prop('checked', this.checked);
    });

    // Preview button handler
    $('#preview-btn').on('click', function() {
        const formData = new FormData($('#download-form')[0]);
        const data = {};
        formData.forEach((value, key) => {
            if (key === 'csrfmiddlewaretoken') return;
            if (key === 'format') return;
            if (['ph', 'cod', 'bod', 'tss'].includes(key) || key.startsWith('flow') || key.startsWith('daily_flow')) {
                if (value === 'on') data[key] = true;
            } else {
                data[key] = value;
            }
        });

        if (!data.start_date || !data.end_date) {
            alert('Please select both start and end dates.');
            return;
        }

        if (!Object.keys(data).some(key => ['ph', 'cod', 'bod', 'tss'].includes(key) || key.startsWith('flow') || key.startsWith('daily_flow'))) {
            alert('Please select at least one parameter.');
            return;
        }

        $.ajax({
            url: '{% url "preview_data" user.id %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.error) {
                    alert(response.error);
                    $('#preview-section').hide();
                    return;
                }
                const fields = response.fields;
                const data = response.data;

                // Build table headers
                const thead = $('#preview-table thead');
                thead.empty();
                const headerRow = $('<tr></tr>');
                headerRow.append('<th>Date/Time</th>');
                fields.forEach(field => {
                    let unit = '';
                    if (field.startsWith('flow') && !['total', 'daily', 'monthly'].some(s => field.includes(s))) {
                        unit = ' (L/min)';
                    } else if (field.startsWith('flow') || field.startsWith('daily_flow')) {
                        unit = ' (L)';
                    } else if (['cod', 'bod', 'tss'].includes(field)) {
                        unit = ' (mg/L)';
                    }
                    const displayName = field.startsWith('daily_flow') ? 
                        field.replace('daily_flow', 'Flow ').replace('_', ' ') + ' Daily Total' : 
                        field.toUpperCase();
                    headerRow.append(`<th>${displayName}${unit}</th>`);
                });
                thead.append(headerRow);

                // Build table body
                const tbody = $('#preview-table tbody');
                tbody.empty();
                data.forEach(row => {
                    const tr = $('<tr></tr>');
                    tr.append(`<td>${new Date(row.timestamp).toLocaleString()}</td>`);
                    fields.forEach(field => {
                        const value = row[field];
                        tr.append(`<td>${value !== undefined && value !== null ? Number(value).toFixed(2) : '-'}</td>`);
                    });
                    tbody.append(tr);
                });

                $('#preview-section').show();
            },
            error: function(xhr) {
                let errorMsg = 'Error fetching preview data.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                alert(errorMsg);
                $('#preview-section').hide();
            }
        });
    });

    // Download button handler
    $('#download-btn').on('click', function() {
        const formData = new FormData($('#download-form')[0]);
        const data = {};
        formData.forEach((value, key) => {
            if (key === 'csrfmiddlewaretoken') return;
            if (['ph', 'cod', 'bod', 'tss'].includes(key) || key.startsWith('flow') || key.startsWith('daily_flow')) {
                if (value === 'on') data[key] = true;
            } else {
                data[key] = value;
            }
        });

        if (!data.start_date || !data.end_date) {
            alert('Please select both start and end dates.');
            return;
        }

        if (!Object.keys(data).some(key => ['ph', 'cod', 'bod', 'tss'].includes(key) || key.startsWith('flow') || key.startsWith('daily_flow'))) {
            alert('Please select at least one parameter.');
            return;
        }

        $.ajax({
            url: '{% url "download_data" user.id %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            contentType: 'application/json',
            data: JSON.stringify(data),
            xhrFields: {
                responseType: 'blob'
            },
            success: function(data, status, xhr) {
                const contentType = xhr.getResponseHeader('Content-Type');
                const contentDisposition = xhr.getResponseHeader('Content-Disposition');
                const filename = contentDisposition.match(/filename="(.+)"/)[1];

                const blob = new Blob([data], { type: contentType });
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            error: function(xhr) {
                let errorMsg = 'Error downloading file.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                } else if (xhr.responseText) {
                    errorMsg = xhr.responseText;
                }
                alert(errorMsg);
            }
        });
    });
});
</script>
{% endblock %}
